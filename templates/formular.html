<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autocomplete Formular</title>
    <!-- Include Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <h1>Formular Beneficiar</h1>
    <form id="beneficiarForm">
        <label for="id_beneficiar">Beneficiar:</label>
        <select id="id_beneficiar" name="beneficiar">
            <option value="">SelecteazÄƒ un beneficiar</option>
            {% for beneficiar in beneficiari %}
                <option value="{{ beneficiar.id }}">{{ beneficiar.nume }} {{ beneficiar.prenume }}</option>
            {% endfor %}
        </select>

        <label for="id_nume">Nume:</label>
        <input type="text" id="id_nume" name="nume" readonly>

        <label for="id_prenume">Prenume:</label>
        <input type="text" id="id_prenume" name="prenume" readonly>

        <label for="id_telefon">Telefon:</label>
        <input type="text" id="id_telefon" name="telefon" readonly>

        <label for="id_tip_client">Tip Client:</label>
        <input type="text" id="id_tip_client" name="tip_client" readonly>
    </form>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            console.log("âœ… JavaScript Ã®ncÄƒrcat!");

            // SelecteazÄƒ cÃ¢mpul beneficiar
            const beneficiarField = document.querySelector("#id_beneficiar");
            console.log("ğŸ› ï¸ CÃ¢mp beneficiar:", beneficiarField);

            // VerificÄƒ dacÄƒ cÃ¢mpul beneficiar existÄƒ
            if (!beneficiarField) {
                console.error("âŒ CÃ¢mpul beneficiar NU a fost gÄƒsit!");
                return;
            }

            console.log("âœ… CÃ¢mp beneficiar detectat!");

            // SelecteazÄƒ cÃ¢mpurile care trebuie completate automat
            const numeField = document.querySelector("#id_nume");
            const prenumeField = document.querySelector("#id_prenume");
            const telefonField = document.querySelector("#id_telefon");
            const tipClientField = document.querySelector("#id_tip_client");

            // VerificÄƒ dacÄƒ toate cÃ¢mpurile necesare existÄƒ
            const cÃ¢mpuriNecesare = { numeField, prenumeField, telefonField, tipClientField };
            let toateCÃ¢mpurileExistÄƒ = true;

            for (const [numeCÃ¢mp, cÃ¢mp] of Object.entries(cÃ¢mpuriNecesare)) {
                if (!cÃ¢mp) {
                    console.error(`âŒ CÃ¢mpul ${numeCÃ¢mp} NU a fost gÄƒsit!`);
                    toateCÃ¢mpurileExistÄƒ = false;
                }
            }

            if (!toateCÃ¢mpurileExistÄƒ) {
                console.error("âŒ Unul sau mai multe cÃ¢mpuri lipsesc!");
                return;
            }

            console.log("âœ… Toate cÃ¢mpurile necesare sunt prezente!");

            // AdaugÄƒ evenimentul `change` la cÃ¢mpul beneficiar
            let previousBeneficiarId = null;

            beneficiarField.addEventListener("change", async function () {
                console.log("ğŸ¯ Eveniment change declanÈ™at!");

                const beneficiarId = beneficiarField.value;
                console.log("ğŸ¯ ID Beneficiar selectat:", beneficiarId);

                // VerificÄƒ dacÄƒ a fost selectat un beneficiar
                if (!beneficiarId) {
                    console.warn("âš ï¸ Niciun beneficiar selectat!");
                    return;
                }

                // VerificÄƒ dacÄƒ valoarea s-a schimbat
                if (beneficiarId === previousBeneficiarId) {
                    console.warn("âš ï¸ AceeaÈ™i valoare selectatÄƒ, evenimentul nu se declanÈ™eazÄƒ.");
                    return;
                }

                previousBeneficiarId = beneficiarId;

                try {
                    console.log(`ğŸ”— Pornim cererea Axios pentru beneficiar ID: ${beneficiarId}`);
                    const url = `/api/get_beneficiar/${beneficiarId}/`;
                    console.log("ğŸ› ï¸ URL cerere Axios:", url);

                    // FoloseÈ™te Axios pentru a face cererea HTTP
                    const response = await axios.get(url);
                    console.log("ğŸ“¦ RÄƒspuns de la API:", response);

                    // Extrage datele din rÄƒspuns
                    const data = response.data;
                    console.log("ğŸ“¦ Date primite de la API:", data);

                    // Debug: AfiÈ™eazÄƒ structura datelor primite
                    console.log("ğŸ› ï¸ Structura datelor:", {
                        nume: data.nume,
                        prenume: data.prenume,
                        telefon: data.telefon,
                        tip_client: data.tip_client,
                    });

                    // CompleteazÄƒ cÃ¢mpurile cu datele primite
                    numeField.value = data.nume || "";
                    prenumeField.value = data.prenume || "";
                    telefonField.value = data.telefon || "";
                    tipClientField.value = data.tip_client || "";

                    console.log("âœ… CÃ¢mpurile au fost completate automat!");
                } catch (error) {
                    console.error("âŒ Eroare Axios:", error);

                    // ReseteazÄƒ cÃ¢mpurile Ã®n caz de eroare
                    numeField.value = "";
                    prenumeField.value = "";
                    telefonField.value = "";
                    tipClientField.value = "";

                    console.warn("âš ï¸ CÃ¢mpurile au fost resetate din cauza unei erori.");
                }
            });

            // Debug: VerificÄƒ dacÄƒ evenimentul a fost ataÈ™at cu succes
            console.log("ğŸ› ï¸ Evenimentul 'change' a fost ataÈ™at la cÃ¢mpul beneficiar.");
        });
    </script>
</body>
</html>